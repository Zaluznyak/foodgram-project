# УЦ КУЦ API

* [Заголовки запросов](#_1)
    * [1. продуктовая среда]()
    * [2. тестовая среда]()
* [Первичное получение](#_2)
    * [1. Создание заявки]()
    * [2. Отправка на выпуск]()
    * [3. Выпуск]()
    * [4. Внешний вызов]()
    * [5. Завершение]()
* [Продление](#_3)
    * [1. Создание заявки]()
    * [2. Отправка на выпуск]()
    * [3. Выпуск]()
    * [4. Внешний вызов]()
    * [5. Завершение]()
* [Внешние вызовы](#_4)
    * [1. Отправка сертификата]()
    * [2. Сообщение об ошибке]()

## Заголовки запросов

#### 1. продуктовая среда

для аутентификации:

```
POST https://online.sbis.ru/auth/service/?srv=1 HTTP/1.1
Content-Type: application/json-rpc;charset=utf-8
```

для остальных:

```
POST https://online.sbis.ru/service/?srv=1 HTTP/1.1
Content-Type: application/json-rpc;charset=utf-8
X-SBISSessionID: 0000ea78-0000ea79-00ba-d3b85272bc0c4842
```

#### 2. тестовая среда

для аутентификации:

```
POST https://fix-online.sbis.ru/auth/service/?srv=1 HTTP/1.1
Content-Type: application/json-rpc;charset=utf-8
```

для остальных:

```
POST https://fix-online.sbis.ru/service/?srv=1 HTTP/1.1
Content-Type: application/json-rpc;charset=utf-8
X-SBISSessionID: 0000ea78-0000ea79-00ba-d3b85272bc0c4842
```

## Первичное получение

#### 1. Создание заявки

Действия:

* Проверяем подпись представителя
* Создаем заявку
* Заполняем реквизиты
* Запускаем заявку в работу на этап ожидание
* Выполняем формирование заявления и формируем результат

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ЗаписатьДокумент",
        "params": {
        "Документ": {
            "Тип": "МинздравМордовииПервичнаяВыдача",
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Вложение": [{
                "Тип": "Реквизиты заявки",
                "Файл": {
                    "Имя": "Реквизиты заявки.json",
                    "ДвоичныеДанные": "BASE64"
                },
                "Подпись": {
                    "Файл": {
                        "ДвоичныеДанные": "Подпись представителя BASE64"
                    }
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{
    "jsonrpc": "2.0",
    "result": {
        "Номер": "Номер документа",
        "Вложение": [{
            "Тип": "Заявление на изготовление сертификата",
            "Файл": {
                "Имя": "Заявление на изготовление сертификата.pdf",
                "ДвоичныеДанные": "BASE64"
            }
        }]
    },
    "id": 0
}
```

Пример ошибки:

```json
{
    "jsonrpc": "2.0",
    "error": {
        "code": -32000,
        "message": "Возникли проблемы при создании заявки!"
    },
    "id": 0
}
```


#### 2. Отправка на выпуск

Действия: (этап: ожидание)

* Прикрепляем паспортРФ в формате pdf, png, jpg, jpeg
* Прикрепляем запрос
* Отправляем заявку на экспертизу, если не требуется, то сразу на выпуск

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ВыполнитьДействие",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Этап": {
                "Действие": [
			{
				"Название": "Отправка на выпуск"
			}
		],
		"Вложение": [
			{
				"Тип": "Запрос",
				"Файл": {
					"Имя": "Запрос.pcks10",
					"ДвоичныеДанные": "BASE64"
				}
			},
			{
				"Тип": "ПаспортРФ",
				"Файл": {
					"Имя": "ПаспортРФ.png",
					"ДвоичныеДанные": "BASE64"
				}
			}
		]
	}
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

#### 3. Выпуск

проходит автоматически

Действия:

* Отправляем заявку на сканирование

#### 4. Внешний вызов

Действия:

* Отправляем пакет ("Лист ознакомления.pdf", "Сертификат.cer") через API клиента

#### 5. Завершение

Действия: (этап: сканирование)

* Прикрепляем лист ознакомления и заявление в формате pdf, png, jpg, jpeg
* Завершение получения ЭП

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ВыполнитьДействие",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Этап": {
                "Действие": [{
                    "Название": "Завершение"
                }]
            },
            "Вложение": [{
                "Тип": "Лист ознакомления",
                "Файл": {
                    "Имя": "Лист ознакомления.png",
                    "ДвоичныеДанные": "BASE64"
                }
            },{
                "Тип": "Заявление на изготовление сертификата",
                "Файл": {
                    "Имя": "Заявление на изготовление сертификата.png",
                    "ДвоичныеДанные": "BASE64"
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

## Продление

#### 1. Создание заявки

Действия:

* Создаем заявку
* Заполняем реквизиты
* Запускаем заявку в работу на этап ожидание
* Выполняем формирование заявления и формируем результат

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ЗаписатьДокумент",
        "params": {
        "Документ": {
            "Тип": "МинздравМордовииПродление",
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Вложение": [{
                "Тип": "Реквизиты заявки",
                "Файл": {
                    "Имя": "Реквизиты заявки.json",
                    "ДвоичныеДанные": "BASE64"
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{
    "jsonrpc": "2.0",
    "result": {
        "Номер": "Номер документа",
        "Вложение": [{
            "Тип": "Заявление на изготовление сертификата",
            "Файл": {
                "Имя": "Заявление на изготовление сертификата.pdf",
                "ДвоичныеДанные": "BASE64"
            }
        }]
    },
    "id": 0
}
```

#### 2. Отправка на выпуск

* Проверяем подпись владельца
* Прикрепляем паспортРФ в формате pdf, png, jpg, jpeg
* Прикрепляем заявление (файл должен совпадать с тем, что мы вернули)
* Прикрепляем запрос
* Отправляем заявку на экспертизу, если не требуется, то сразу на выпуск

Действия: (этап: ожидание)

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ВыполнитьДействие",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Этап": {
                "Действие": [{
                    "Название": "Отправка на выпуск"
                }]
            },
            "Вложение": [{
                "Тип": "Запрос",
                "Файл": {
                    "Имя": "Запрос.pcks10",
                    "ДвоичныеДанные": "BASE64"
                }
            },{
                "Тип": "ПаспортРФ",
                "Файл": {
                    "Имя": "ПаспортРФ.png",
                    "ДвоичныеДанные": "BASE64"
                }
            },{
                "Тип": "Заявление на изготовление сертификата",
                "Файл": {
                    "Имя": "Заявление на изготовление сертификата.pdf",
                    "ДвоичныеДанные": "BASE64"
                },
                "Подпись": {
                    "Файл": {
                        "ДвоичныеДанные": "Подпись представителя BASE64"
                    }
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

#### 3. Выпуск

проходит автоматически

Действия:

* Отправляем заявку на подпись клиентом листа ознакомления

#### 4. Внешний вызов

Действия:

* Отправляем пакет ("Лист ознакомления.pdf", "Сертификат.cer") через API клиента


#### 5. Завершение

Действия: (этап: подпись клиентом листа ознакомления)

* Прикрепляем лист ознакомления (файл должен совпадать с тем, что мы вернули)
* Завершение получения ЭП

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийАгентУЦ.ВыполнитьДействие",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
            "Этап": {
                "Действие": [{
                    "Название": "Завершение"
                }]
            },
            "Вложение": [{
                "Тип": "Лист ознакомления",
                "Файл": {
                    "Имя": "Лист ознакомления.pdf",
                    "ДвоичныеДанные": "BASE64"
                },
                "Подпись": {
                    "Файл": {
                        "ДвоичныеДанные": "Подпись владельца BASE64"
                    }
                }
            },{
                "Тип": "Заявление на изготовление сертификата",
                "Файл": {
                    "Имя": "Заявление на изготовление сертификата.pdf",
                    "ДвоичныеДанные": "BASE64"
                },
                "Подпись": {
                    "Файл": {
                        "ДвоичныеДанные": "Подпись владельца BASE64"
                    }
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

## Внешние вызовы

#### 1. Отправка сертификата

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийВызов.ОтправитьСертификат",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003",
	    "Сертификат":
	    {
            	"Серийный номер": "05F2509900D8B0849F402792B6923E4EE5",
		"Отпечаток": "AE1B098C30D69B79E8A0E11C0E67A454E3C07A32",
		"Действителен с": "2023-12-14 12:08:12",
		"Действителен до": "2024-12-14 12:08:12"
	    },
            "Вложение": [{
                "Тип": "Лист ознакомления",
                "Файл": {
                    "Имя": "Лист ознакомления.pdf",
                    "ДвоичныеДанные": "BASE64"
                }
            },{
                "Тип": "Сертификат",
                "Файл": {
                    "Имя": "Сертификат.cer",
                    "ДвоичныеДанные": "BASE64"
                }
            }]
        }
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

Пример ошибки:

```json
{
    "jsonrpc": "2.0",
    "error": {
        "code": -32000,
        "message": "Возникли проблемы!"
    },
    "id": 0
}
```

#### 2. Сообщение об ошибке

Пример запроса:

```json
{
    "jsonrpc": "2.0",
    "method": "ВнешнийВызов.СообщитьОбОшибке",
    "params": {
        "Документ": {
            "Идентификатор": "36a9a74c-d5b4-11eb-b8bc-0242ac130003"
        },
        "Сообщение": "Возникли проблемы при выпуске сертификата!"
    },
    "id": 0
}
```

Пример ответа:

```json
{"jsonrpc":"2.0","result":{},"id":0}
```

Пример ошибки:

```json
{
    "jsonrpc": "2.0",
    "error": {
        "code": -32000,
        "message": "Возникли проблемы!"
    },
    "id": 0
}
```
